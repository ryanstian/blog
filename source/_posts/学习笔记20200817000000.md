---
title: 学习笔记20200817000000
date: 2020-08-17 23:27:00
categories: 学习笔记
tags: []
copyright: true #新增,开启
---

关于微服务方面的笔记,这仅以我的视角来看,而非行业发展的顺序

最初接触到服务端,还是这种的单机架构,这事也很多初学者第一次写代码接触的

![如果图片失效,请邮件联系作者补图](单机.png)
<center>单机架构</center>

后来,接触到了分布式架构。当然,仅仅是半分布式。

![如果图片失效,请邮件联系作者补图](分布式业务_单机数据库.png)
<center>分布式业务_单机数据库</center>

当时面对这个架构,我有想过一些问题,例如:这样的话,仅仅是降低了业务服务器压力,但是并不能降低数据库压力,反而数据库压力更大,那么当时的想法便是,将数据库拆散到每一个服务中去,各服务通过远程调用交互。

变成了这张图所示,从中可以看到,要说他是分布式吧,他确实是分布式,毕竟数据库可以做分库分表,服务也可以水平扩展。

但是这种架构存在着一个致命的问题,那便是服务依赖。在以前,我们写sql时往往会夹杂很多join语句做联表查询,我们往往还以写出优秀的复杂查询语句为荣。

但现在,这成为了巨大的包袱。由于表被拆分到各个服务了,那么以前的join语句也被拆分成了一条条的语句到不同服务,那么服务间会频繁进行远程调用来交互数据,当业务逐渐复杂,几个服务就会互相形成环状甚至网状

即使在设计初期就划分好了职责范围,那么随着业务复杂度的上升,无法避免某两个微服务的职责范围会产生重叠,乃至融合在一起,连带效应几个微服务也融合在一起,最终虽然是分布式部署,但是从业务上,他们已经成为了单机系统

![如果图片失效,请邮件联系作者补图](单纯的分布式微服务.png)
<center>单纯的分布式微服务</center>

当时我也曾遭遇了这种问题,直到我听到了两句话
+ sql中不允许出现join语句或者其他联表语句,不允许出现外键
+ 垂直分层

是的,想想为什么我们明明是分布式,却最终像个单机一样。一个原因是我们的sql导致了表于表之间产生强依赖关系,无法独立。另一个原因是,我们将微服务聚合的责任扔给了微服务自己,而不是第三方。

那么基于以上,我们就可以将业务进行分层,库表自治,基于以下几个原则
+ 数据库仅充当存储功能,而不应该融合业务逻辑(联表也算作业务逻辑)。数据库仅当作存储功能后,表于表,库与库之间的强依赖被解除,可以随意拆分,由于不与业务逻辑融合,我们完全可以将分库分表做在框架层,使得业务无感知
+ 微服务垂直分层,平时我们谈的高内聚低耦合,在模块设计上便体现出来,如果需要因为业务原因产生微服务交互,应该判断交互程度,如果多个微服务需要两两调用,那么应该将其分割,基础微服务沉降到底层,由上级微服务聚合多个下级微服务,以此类推,逐级沉降
+ 不应过分设计,应依托于具体需要以及开发难度,展望未来发展速度。例如某个大学图书馆的图书管理系统搞个垂直分层,搞十几个微服务,那么完全就是牛刀杀鸡,毫无意义(当然学习之用除外)

![如果图片失效,请邮件联系作者补图](垂直分层.png)
<center>垂直分层</center>

那么如何改进,或者说何时改进?
+ 监控系统,监控方法,sql,业务线频率以及时间,抽离出高频,核心的模块来做沉降和重构
+ 当开发难度过大,优化所耗费时间<开发所需付出额外精力
+ 业务空闲时

还需了解的地方:容灾,微服务多层的雪崩