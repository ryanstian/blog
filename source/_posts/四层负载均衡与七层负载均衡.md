---
title: 四层负载均衡与七层负载均衡
date: 2021-09-06 09:17:00
categories: 负载均衡
tags: []
copyright: true #新增,开启
---

介绍下，当一个外部请求到达服务器时，我们是如何来做负载均衡的。以及每层负载均衡的意义

<!--more-->
负载均衡其实就是反向代理  
当一个请求过来时，首先会跟前方负载均衡设备建立通信，负载均衡设备将请求转发给后续设备。后续设备处理完请求，将结果消息发送给负载均衡设备，结果消息原路返回。  
- 正向代理是做在客户端的，反向代理做在服务端。反向代理消息接收和返回，均需经过反向代理，而非后台服务处理后，直接绕过反向代理发送给客户端

所谓几层负载均衡，其实就是指的OSI模型中，第几层做负载均衡  
![如果图片失效,请邮件联系作者补图](OSI七层模型图.png)

四层负载均衡做在传输层，七层负载均衡做在应用层  
其作用，也与OSI每层特点有关。  
- 第四层基于tcp协议，此时的负载均衡是基于ip+port进行转发。不会解析具体消息内容
- 第七层基于http协议，此时的负载均衡较为灵活，可选择基于内容转发
  
我们平时会结合很多层代理使用，当然也可以单独用一层代理
- 首先客户端会访问dns，这时候一般会将dns绑定到多个ip，来做负载均衡
- ip为虚拟IP，对应四层代理集群
- 四层代理集群通过ip+端口转发到七层代理集群
- 七层代理通过解析消息，根据URL可灵活调整转发至哪个服务，也可在接收响应后再将其转发到其他服务，例如鉴权等

问：为何不只采用四层代理？
七层代理由于解析消息，可以根据具体内容，做到更多转发能力，例如静态动态数据分别转发等  
七层代理基于HTTP协议，可使后续服务免受Synflooding攻击


问：为何不直接跳过四层代理做七层代理？  
也可以直接做七层代理，平时我们单独搭个nginx，可以视为七层代理。  
但问题在于，七层代理需要解析消息，也就意味着更大的开销。多层代理其实就相当于将压力分摊到每层

问：为何多层代理可以将压力分摊到每层？  
其实我们网络传输时，消息会拆分成一个个数据包传输。  
这就意味着，第一个数据包到达和全部数据包到达，这之间由于网络状况会存在延迟，在这期间我们会持续保持与客户端通信。  
如果外部网络过差，则保持这种慢链接会严重影响我们后续处理速度。  
每层的代理其实也起到，将慢链接转换成快链接的作用（即全部接收后再转发给后续服务，内网传输网络质量有保证），

常用的四层负载均衡设备：
F5：硬件设备，成本高，效率高
LVS：软件设备
Nginx：软件设备
haproxy：软件设备

常用七层负载均衡设备：
一切软件设备（这一层其实跟我们写业务属于同一层，只要能解析消息，就能转发）

通常来讲，四层七层都采用软件负载均衡就够了，除非到一定规模才考虑硬件负载均衡

负载均衡常用算法：
- 轮询
- 随机
- 权重：例如按比例
- 响应速度
- 最少连接
- 处理能力：例如按CPU使用率

负载均衡其他内容：
- 会话保持